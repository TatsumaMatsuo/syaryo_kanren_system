# 車両関連書類管理システム - 環境構築手順書

---

## 目次

1. [前提条件](#1-前提条件)
2. [開発環境のセットアップ](#2-開発環境のセットアップ)
3. [ソースコードの取得](#3-ソースコードの取得)
4. [依存パッケージのインストール](#4-依存パッケージのインストール)
5. [Larkアプリケーションの設定](#5-larkアプリケーションの設定)
6. [Lark Baseの設定](#6-lark-baseの設定)
7. [環境変数の設定](#7-環境変数の設定)
8. [開発サーバーの起動](#8-開発サーバーの起動)
9. [動作確認](#9-動作確認)
10. [トラブルシューティング](#10-トラブルシューティング)

---

## 1. 前提条件

### 1.1 必要なソフトウェア

| ソフトウェア | バージョン | 確認コマンド |
|-------------|-----------|-------------|
| Node.js | 20.x 以上 | `node -v` |
| npm | 10.x 以上 | `npm -v` |
| Git | 2.x 以上 | `git --version` |

### 1.2 必要なアカウント

- **Lark（Feishu）アカウント**: 社内Larkワークスペースへのアクセス権
- **GitHub アカウント**: リポジトリへのアクセス権
- **Vercel アカウント**（本番デプロイ時のみ）

### 1.3 推奨開発環境

- **エディタ**: Visual Studio Code
- **推奨拡張機能**:
  - ESLint
  - Prettier - Code formatter
  - Tailwind CSS IntelliSense
  - TypeScript Importer

---

## 2. 開発環境のセットアップ

### 2.1 Node.js のインストール

#### Windows

1. [Node.js公式サイト](https://nodejs.org/) から LTS版をダウンロード
2. インストーラーを実行
3. インストール確認:
   ```bash
   node -v
   npm -v
   ```

#### macOS

```bash
# Homebrewを使用
brew install node@20

# バージョン確認
node -v
npm -v
```

#### Linux (Ubuntu/Debian)

```bash
# NodeSourceリポジトリを追加
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -

# Node.jsをインストール
sudo apt-get install -y nodejs

# バージョン確認
node -v
npm -v
```

### 2.2 Git のインストール

#### Windows

1. [Git公式サイト](https://git-scm.com/) からインストーラーをダウンロード
2. インストール（デフォルト設定で可）

#### macOS

```bash
brew install git
```

#### Linux

```bash
sudo apt-get install git
```

---

## 3. ソースコードの取得

### 3.1 リポジトリのクローン

```bash
# HTTPSでクローン
git clone https://github.com/TatsumaMatsuo/syaryo_kanren_system.git

# ディレクトリに移動
cd syaryo_kanren_system
```

### 3.2 ブランチの確認

```bash
# 現在のブランチを確認
git branch

# mainブランチにいることを確認
git checkout main
```

---

## 4. 依存パッケージのインストール

### 4.1 パッケージのインストール

```bash
npm install
```

### 4.2 インストールされる主要パッケージ

| パッケージ | 用途 |
|-----------|------|
| next | フレームワーク (Next.js 15) |
| react | UIライブラリ (React 19) |
| @larksuiteoapi/node-sdk | Lark API SDK |
| next-auth | 認証ライブラリ |
| tailwindcss | CSSフレームワーク |
| zod | バリデーション |
| @tanstack/react-query | データフェッチング |
| @react-pdf/renderer | PDF生成 |
| recharts | グラフ表示 |

---

## 5. Larkアプリケーションの設定

### 5.1 アプリケーションの作成

1. [Lark Open Platform](https://open.feishu.cn/) にアクセス
2. 「アプリを作成」をクリック
3. アプリケーション情報を入力:
   - アプリ名: `車両関連管理システム`
   - アプリの説明: 任意

### 5.2 認証情報の取得

アプリ管理画面から以下を控える:
- **App ID**: `LARK_APP_ID` として使用
- **App Secret**: `LARK_APP_SECRET` として使用

### 5.3 OAuth設定

1. 「セキュリティ設定」→「リダイレクトURL」に追加:
   ```
   http://localhost:3000/api/auth/callback/lark
   ```

2. OAuth クライアントIDとシークレットを取得:
   - `LARK_OAUTH_CLIENT_ID`
   - `LARK_OAUTH_CLIENT_SECRET`

### 5.4 権限スコープの設定

「権限管理」で以下のスコープを申請・有効化:

| スコープ | 説明 |
|---------|------|
| `bitable:app` | Base アプリケーションへのアクセス |
| `bitable:app:readonly` | Base 読み取り |
| `contact:user.base:readonly` | ユーザー基本情報読み取り |
| `contact:user.email:readonly` | ユーザーメール読み取り |
| `im:message` | メッセージ送信（通知用） |

### 5.5 アプリの公開

1. 「バージョン管理」でバージョンを作成
2. 管理者に申請を送信
3. 承認後、アプリが利用可能に

---

## 6. Lark Baseの設定

### 6.1 Baseの作成

1. Larkアプリで「Base」を開く
2. 「新規作成」→「空のBase」
3. Base名: `車両管理システム`

### 6.2 テーブルの作成

以下のテーブルを作成（詳細は `docs/LARK_BASE_SETUP.md` 参照）:

1. **社員マスタ** (`employees`)
2. **免許証** (`drivers_licenses`)
3. **車検証** (`vehicle_registrations`)
4. **任意保険証** (`insurance_policies`)
5. **ユーザー権限** (`user_permissions`)
6. **通知履歴** (`notification_history`)
7. **承認履歴** (`approval_history`)
8. **システム設定** (`system_settings`)

### 6.3 テーブルIDの取得

各テーブルを開き、URLからテーブルIDを取得:
```
https://xxx.feishu.cn/base/BASE_TOKEN?table=TABLE_ID&view=VIEW_ID
                           ↑                    ↑
                      Base Token           Table ID
```

### 6.4 アプリにBaseへのアクセス権を付与

1. Baseの「共有」設定を開く
2. 作成したLarkアプリを追加
3. 「編集可能」権限を付与

---

## 7. 環境変数の設定

### 7.1 環境変数ファイルの作成

```bash
# テンプレートからコピー
cp .env.example .env.local
```

### 7.2 環境変数の設定

`.env.local` ファイルを編集:

```bash
# ===================
# Lark Base 設定
# ===================
LARK_APP_ID=cli_xxxxxxxxxx
LARK_APP_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
LARK_BASE_TOKEN=xxxxxxxxxxxxxxxx

# ===================
# Lark Base テーブルID
# ===================
LARK_TABLE_DRIVERS_LICENSES=tblXXXXXXXXXXXXXX
LARK_TABLE_VEHICLE_REGISTRATIONS=tblXXXXXXXXXXXXXX
LARK_TABLE_INSURANCE_POLICIES=tblXXXXXXXXXXXXXX
LARK_TABLE_EMPLOYEES=tblXXXXXXXXXXXXXX
LARK_TABLE_USER_PERMISSIONS=tblXXXXXXXXXXXXXX
LARK_TABLE_NOTIFICATION_HISTORY=tblXXXXXXXXXXXXXX
LARK_APPROVAL_HISTORY_TABLE_ID=tblXXXXXXXXXXXXXX

# ===================
# Lark OAuth 設定
# ===================
LARK_OAUTH_CLIENT_ID=cli_xxxxxxxxxx
LARK_OAUTH_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
LARK_OAUTH_REDIRECT_URI=http://localhost:3000/api/auth/callback/lark

# ===================
# NextAuth 設定
# ===================
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here

# ===================
# 通知設定（任意）
# ===================
LARK_BOT_WEBHOOK_URL=
LARK_DRIVE_FOLDER_ID=

# ===================
# その他
# ===================
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 7.3 NEXTAUTH_SECRET の生成

```bash
# OpenSSL で生成
openssl rand -base64 32
```

生成された文字列を `NEXTAUTH_SECRET` に設定。

---

## 8. 開発サーバーの起動

### 8.1 開発サーバーの起動

```bash
npm run dev
```

### 8.2 アクセス確認

ブラウザで以下にアクセス:
```
http://localhost:3000
```

### 8.3 その他のコマンド

| コマンド | 説明 |
|---------|------|
| `npm run dev` | 開発サーバー起動 |
| `npm run build` | プロダクションビルド |
| `npm run start` | プロダクションサーバー起動 |
| `npm run lint` | ESLint実行 |
| `npm run format` | Prettier実行 |
| `npm run test` | テスト実行 |

---

## 9. 動作確認

### 9.1 ログイン確認

1. `http://localhost:3000` にアクセス
2. 「Larkでログイン」をクリック
3. Larkアカウントで認証
4. ダッシュボードが表示されることを確認

### 9.2 API接続確認

```bash
# ヘルスチェック
curl http://localhost:3000/api/health

# Lark接続テスト
curl http://localhost:3000/api/test/lark-connection
```

### 9.3 基本機能の確認

- [ ] ログイン/ログアウト
- [ ] ダッシュボード表示
- [ ] 書類申請フォーム表示
- [ ] 画像アップロード

---

## 10. トラブルシューティング

### 10.1 npm install でエラーが発生する

```bash
# キャッシュをクリア
npm cache clean --force

# node_modules を削除して再インストール
rm -rf node_modules
rm package-lock.json
npm install
```

### 10.2 Lark認証エラー

**エラー**: `Invalid app_id or app_secret`

**対処法**:
- `LARK_APP_ID` と `LARK_APP_SECRET` が正しいか確認
- アプリが公開されているか確認

### 10.3 Lark Base接続エラー

**エラー**: `Table not found` または `Permission denied`

**対処法**:
- `LARK_BASE_TOKEN` が正しいか確認
- テーブルIDが正しいか確認
- アプリにBaseへのアクセス権が付与されているか確認

### 10.4 OAuth リダイレクトエラー

**エラー**: `redirect_uri_mismatch`

**対処法**:
- Lark Open Platform のリダイレクトURL設定を確認
- `LARK_OAUTH_REDIRECT_URI` と一致しているか確認
- `http` と `https` の違いに注意

### 10.5 ビルドエラー

```bash
# TypeScriptエラーの確認
npx tsc --noEmit

# ESLintエラーの確認
npm run lint
```

### 10.6 ポートが使用中

**エラー**: `Port 3000 is already in use`

**対処法**:
```bash
# 別のポートで起動
npm run dev -- -p 3001
```

---

## 付録

### A. ディレクトリ構成

```
syaryo_kanren_system/
├── app/                    # Next.js App Router
│   ├── (admin)/           # 管理者向けページ
│   ├── (applicant)/       # 申請者向けページ
│   └── api/               # APIルート
├── components/            # Reactコンポーネント
├── services/              # ビジネスロジック
├── lib/                   # ユーティリティ
├── types/                 # TypeScript型定義
├── docs/                  # ドキュメント
└── public/                # 静的ファイル
```

### B. 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `docs/01_システム概要.md` | システム全体の概要 |
| `docs/02_操作マニュアル_申請者向け.md` | 申請者向け操作手順 |
| `docs/03_操作マニュアル_管理者向け.md` | 管理者向け操作手順 |
| `docs/04_業務フロー図.md` | 業務フローの詳細 |
| `docs/LARK_BASE_SETUP.md` | Lark Baseテーブル設定 |
| `docs/DEPLOYMENT.md` | 本番デプロイ手順 |

### C. 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フレームワーク | Next.js 15 (App Router) |
| 言語 | TypeScript |
| UI | React 19, Tailwind CSS |
| 認証 | NextAuth.js + Lark OAuth |
| データベース | Lark Base |
| PDF生成 | @react-pdf/renderer |
| 状態管理 | TanStack Query |
| デプロイ | Vercel |
| エラー監視 | Sentry |

---

## お問い合わせ

環境構築で問題が発生した場合は、システム管理者までお問い合わせください。
